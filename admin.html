<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin v2.0 - KANCEL√Å≈ò NADƒöJE</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <style>
        :root { 
            --blue: #00f2ff; --green: #38a169; --red: #e53e3e; --bg: #0f172a; --text: #ffffff;
            --card-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); padding: 20px; color: var(--text); margin: 0; line-height: 1.6; }
        .container { max-width: 900px; margin: 0 auto; }
        .card { background: rgba(255,255,255,0.05); padding: 25px; border-radius: 20px; margin-bottom: 25px; border: 1px solid rgba(0,242,255,0.1); }
        h2 { border-bottom: 2px solid var(--blue); padding-bottom: 10px; font-size: 1.3em; margin-top: 0; }
        label { display: block; margin-top: 15px; font-weight: bold; font-size: 0.8em; opacity: 0.7; text-transform: uppercase; }
        input, textarea { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #334155; border-radius: 10px; background: #000; color: #fff; box-sizing: border-box; font-family: inherit; }
        .btn { padding: 15px; border: none; border-radius: 12px; color: #000; cursor: pointer; width: 100%; font-weight: bold; text-transform: uppercase; margin-top: 10px; transition: 0.3s; }
        .btn-blue { background: var(--blue); }
        .btn-green { background: var(--green); color: white; }
        .btn-red { background: var(--red); color: white; }
        .btn:hover { opacity: 0.8; transform: translateY(-2px); }
        .match-item { background: rgba(255,255,255,0.03); border: 1px solid #334155; padding: 20px; border-radius: 18px; margin-top: 20px; }
        .tag-container { display: flex; flex-wrap: wrap; gap: 8px; margin: 15px 0; background: #000; padding: 10px; border-radius: 12px; min-height: 40px; }
        .tag { background: var(--blue); color: #000; padding: 4px 10px; border-radius: 10px; font-weight: bold; font-size: 0.8em; display: flex; align-items: center; gap: 5px; }
        .modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 95%; max-width: 500px; background: #1e293b; border-radius: 25px; display: none; z-index: 3000; padding: 30px; border: 2px solid var(--blue); }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; z-index: 2999; }
        #statusMsg { display: none; position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: var(--blue); color: #000; padding: 15px 30px; border-radius: 50px; font-weight: bold; z-index: 9999; box-shadow: 0 0 20px var(--blue); }
    </style>
</head>
<body>

<div id="statusMsg">ZPR√ÅVA ODESL√ÅNA! üöÄ</div>

<div class="container">
    <div style="text-align: center; margin-bottom: 20px;">
        <img src="IMG_8429.png" style="max-width: 150px; filter: drop-shadow(0 0 10px var(--blue));">
    </div>

    <div class="card">
        <h2>üí∞ Bank & Statistiky</h2>
        <label>P≈ôevod z minul√Ωch kol (Kƒç):</label>
        <input type="number" id="prevBankInput" placeholder="0">
        <button class="btn btn-blue" onclick="saveBank()">Ulo≈æit bank</button>
    </div>

    <div class="card">
        <h2>üöÄ Vypsat nov√Ω z√°pas</h2>
        <div style="display:flex; gap:10px;">
            <div style="flex:2;"><label>Dom√°c√≠:</label><input type="text" id="d" oninput="autoFlag()" placeholder="T√Ωm dom√°c√≠"></div>
            <div style="flex:1;"><label>K√≥d:</label><input type="text" id="kd" placeholder="cz"></div>
        </div>
        <div style="display:flex; gap:10px;">
            <div style="flex:2;"><label>Host√©:</label><input type="text" id="h" oninput="autoFlag()" placeholder="T√Ωm host√©"></div>
            <div style="flex:1;"><label>K√≥d:</label><input type="text" id="kh" placeholder="ca"></div>
        </div>
        <label>Uz√°vƒõrka (Deadline):</label>
        <input type="datetime-local" id="dl">
        <button class="btn btn-green" onclick="publishMatch()">Uve≈ôejnit na webu</button>
    </div>

    <h2>üìä Aktivn√≠ z√°pasy</h2>
    <div id="activeMatches">Naƒç√≠t√°m...</div>

    <h2 style="margin-top:50px; opacity: 0.5;">üìú Historie (Vyhodnoceno)</h2>
    <div id="historyMatches">Zat√≠m ≈æ√°dn√° historie.</div>
</div>

<div id="modalOverlay" class="modal-overlay" onclick="closeModal()"></div>
<div id="evalModal" class="modal">
    <h3 style="text-align:center">üõ†Ô∏è Vyhodnocen√≠ z√°pasu</h3>
    <div style="display:flex; justify-content:center; gap:15px; margin: 20px 0;">
        <input type="number" id="finalD" style="width:70px; text-align:center; font-size:1.5em;">
        <span style="font-size:1.5em; line-height:2;">:</span>
        <input type="number" id="finalH" style="width:70px; text-align:center; font-size:1.5em;">
    </div>
    <label>St≈ôelci z√°pasu:</label>
    <div id="finalStrelci" class="tag-container"></div>
    <div style="display:flex; gap:10px;">
        <input type="text" id="addStrelecInput" placeholder="Jm√©no st≈ôelce..." style="margin:0;">
        <button class="btn btn-blue" style="width:auto; margin:0; padding:0 20px;" onclick="addManualTag()">+</button>
    </div>
    <button class="btn btn-green" id="confirmEvalBtn">VYPLATIT A P≈òESUNOUT</button>
</div>

<script>
    const firebaseConfig = { 
        apiKey: "AIzaSyC-NCdmsgA42FxnopKm92m1y5gUGw_z_uE", 
        authDomain: "nadeje-208bd.firebaseapp.com", 
        databaseURL: "https://nadeje-208bd-default-rtdb.europe-west1.firebasedatabase.app", 
        projectId: "nadeje-208bd", 
        storageBucket: "nadeje-208bd.firebasestorage.app", 
        messagingSenderId: "688478977789", 
        appId: "1:688478977789:web:512d1520cf96c9e59cc894" 
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    let currentStrelci = [];

    // --- LOGIKA VLAJEK ---
    function autoFlag() {
        const flags = { 
            'ƒçes': 'cz', 'kan': 'ca', 'slo': 'sk', 'usa': 'us', 'fin': 'fi', '≈°v√©': 'se', 
            'nƒõm': 'de', '≈°v√Ω': 'ch', 'rus': 'ru', 'nor': 'no', 'd√°n': 'dk', 'lot': 'lv',
            'fra': 'fr', 'kaz': 'kz', 'rak': 'at', 'pol': 'pl', 'brit': 'gb'
        };
        const dVal = document.getElementById('d').value.toLowerCase();
        const hVal = document.getElementById('h').value.toLowerCase();
        
        for (let key in flags) {
            if (dVal.includes(key)) document.getElementById('kd').value = flags[key];
            if (hVal.includes(key)) document.getElementById('kh').value = flags[key];
        }
    }

    // --- NOTIFIKACE (WEBPUSHR) ---
    async function sendPush(title, msg, scheduledDate = null) {
        const key = "E1831cba358cb7135d498741dc3d4d18";
        const token = "118988";
        let body = {
            "title": title,
            "message": msg,
            "target_url": "https://sazkynadeje.github.io/SazkovkaNadeje/",
            "icon": "https://sazkynadeje.github.io/SazkovkaNadeje/IMG_8429.png"
        };

        if (scheduledDate) {
            const year = scheduledDate.getUTCFullYear();
            const month = String(scheduledDate.getUTCMonth() + 1).padStart(2, '0');
            const day = String(scheduledDate.getUTCDate()).padStart(2, '0');
            const hours = String(scheduledDate.getUTCHours()).padStart(2, '0');
            const mins = String(scheduledDate.getUTCMinutes()).padStart(2, '0');
            body.send_at = `${year}-${month}-${day} ${hours}:${mins}:00`;
        }

        try {
            await fetch('https://api.webpushr.com/v1/notification/send/all', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'webpushrKey': key, 'webpushrAuthToken': token },
                body: JSON.stringify(body)
            });
        } catch(e) { console.error("Push error:", e); }
    }

    // --- SPR√ÅVA Z√ÅPAS≈Æ ---
    async function publishMatch() {
        const d = document.getElementById('d').value, h = document.getElementById('h').value,
              kd = document.getElementById('kd').value, kh = document.getElementById('kh').value, dl = document.getElementById('dl').value;
        
        if(!d || !h || !dl) return alert("Vypl≈à v≈°echny √∫daje!");

        const matchRef = db.ref('sazkyData_v2/zapasy').push();
        await matchRef.set({ domaci: d, hoste: h, kodD: kd, kodH: kh, deadline: dl, status: "aktivni" });

        // 1. Okam≈æit√° notifikace
        await sendPush("Nov√Ω z√°pas vyps√°n! üèí", `${d} vs ${h}. Vsaƒè si vƒças!`);

        // 2. Pl√°novan√° (30 min p≈ôedem)
        const deadlineDate = new Date(dl);
        const reminderDate = new Date(deadlineDate.getTime() - (30 * 60000));
        if (reminderDate > new Date()) {
            await sendPush("Posledn√≠ ≈°ance vsadit! ‚è≥", `Za 30 minut konƒç√≠ s√°zky na ${d} - ${h}!`, reminderDate);
        }

        alert("Z√°pas publikov√°n a notifikace nastaveny!");
        location.reload();
    }

    function saveBank() {
        const val = parseInt(document.getElementById('prevBankInput').value) || 0;
        db.ref('sazkyData_v2/prevedenyBank').set(val).then(() => alert("Bank ulo≈æen."));
    }

    db.ref('sazkyData_v2/prevedenyBank').on('value', s => document.getElementById('prevBankInput').value = s.val() || 0);

    // --- ZOBRAZEN√ç ---
    db.ref('sazkyData_v2/zapasy').on('value', snap => {
        const aC = document.getElementById('activeMatches'), hC = document.getElementById('historyMatches');
        aC.innerHTML = ""; hC.innerHTML = "";
        const data = snap.val(); if(!data) return;

        Object.entries(data).reverse().forEach(([mid, m]) => {
            const div = document.createElement('div'); div.className = 'match-item';
            let betsCount = m.sazky ? Object.keys(m.sazky).length : 0;
            
            div.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <strong>${m.domaci} - ${m.hoste} ${m.vysledek ? ' ('+m.vysledek+')' : ''}</strong>
                    <span style="font-size:0.8em; opacity:0.6;">S√°zek: ${betsCount}</span>
                </div>
                ${m.status === 'aktivni' ? `
                    <textarea id="raw-${mid}" placeholder="Vlo≈æ text z Livesportu pro vyhodnocen√≠..."></textarea>
                    <button class="btn btn-blue" onclick="startEval('${mid}')">VYHODNOTIT</button>
                ` : ''}
                <button class="btn btn-red" style="font-size:0.7em; padding:5px;" onclick="deleteMatch('${mid}')">Smazat z√°pas</button>
            `;
            if(m.status === "vyhodnoceno") hC.appendChild(div); else aC.appendChild(div);
        });
    });

    // --- VYHODNOCEN√ç (LIVESPORT PARSER) ---
    function startEval(mid) {
        const raw = document.getElementById(`raw-${mid}`).value; if(!raw) return alert("Vlo≈æ text!");
        let clean = raw.split(/PRODLOU≈ΩEN√ç|PENALTY|N√ÅJEZDY/i)[0];
        const sc = clean.match(/(\d+)\s*[:|-]\s*(\d+)/g);
        if(sc) {
            const l = sc[sc.length-1].replace(/\s/g,'').replace('-',':').split(':');
            document.getElementById('finalD').value = l[0]; document.getElementById('finalH').value = l[1];
        }
        currentStrelci = [];
        clean.split('\n').forEach(line => {
            if (line.match(/^[\d+]+['.]/)) {
                let n = line.replace(/^[\d+]+['.]\s*/, '').split('(')[0].split(',')[0].replace(/[0-9]/g, '').replace(/[:|-]/g, '').trim();
                if(n.length > 3 && !currentStrelci.includes(n)) currentStrelci.push(n);
            }
        });
        renderTags();
        document.getElementById('modalOverlay').style.display='block';
        document.getElementById('evalModal').style.display='block';
        document.getElementById('confirmEvalBtn').onclick = () => finishEval(mid);
    }

    function renderTags() {
        const c = document.getElementById('finalStrelci'); c.innerHTML = "";
        currentStrelci.forEach((s, i) => c.innerHTML += `<div class="tag">${s} <span onclick="currentStrelci.splice(${i},1);renderTags()" style="cursor:pointer">√ó</span></div>`);
    }

    function addManualTag() {
        const v = document.getElementById('addStrelecInput').value;
        if(v) { currentStrelci.push(v); renderTags(); document.getElementById('addStrelecInput').value = ""; }
    }

    async function finishEval(mid) {
        const d = parseInt(document.getElementById('finalD').value);
        const h = parseInt(document.getElementById('finalH').value);
        const fst = currentStrelci.map(s => s.toLowerCase().trim());

        db.ref(`sazkyData_v2/zapasy/${mid}`).once('value', async snap => {
            const z = snap.val();
            const sazkyEntries = Object.entries(z.sazky || {});
            const bankSnap = await db.ref('sazkyData_v2/prevedenyBank').get();
            const totalBank = (sazkyEntries.length * 20) + (parseInt(bankSnap.val()) || 0);

            let winS = sazkyEntries.filter(([id, s]) => {
                const p = (s.tip || s.skore).split(':');
                return parseInt(p[0]) === d && parseInt(p[1]) === h;
            });
            let winB = winS.filter(([id, s]) => fst.some(r => r.includes(s.strelec.toLowerCase().trim())));
            
            let finalWinners = winB.length > 0 ? winB : winS;
            const updates = {};

            if(finalWinners.length > 0) {
                const share = Math.floor(totalBank / finalWinners.length);
                finalWinners.forEach(([sid, s]) => {
                    updates[`sazkyData_v2/zapasy/${mid}/sazky/${sid}/stav`] = "üèÜ";
                    updates[`sazkyData_v2/zapasy/${mid}/sazky/${sid}/vyhra`] = share;
                    db.ref(`sazkyData_v2/stats/${s.jmeno}/vyhry`).transaction(c => (c||0) + share);
                });
                updates[`sazkyData_v2/prevedenyBank`] = 0;
            } else {
                updates[`sazkyData_v2/prevedenyBank`] = totalBank;
            }

            sazkyEntries.forEach(([sid, s]) => {
                const p = (s.tip || s.skore).split(':');
                const tD = parseInt(p[0]), tH = parseInt(p[1]);
                const hitS = (tD === d && tH === h);
                const hitT = (tD > tH && d > h) || (tD < tH && d < h) || (tD === tH && d === h);
                const hitSt = fst.some(r => r.includes(s.strelec.toLowerCase().trim()));

                let nb = (hitS ? 5 : 0) + (hitSt ? 3 : 0) + (hitT ? 1 : 0);
                db.ref(`sazkyData_v2/stats/${s.jmeno}`).transaction(c => {
                    c = c || {celkoveBody:0, trefeneSkore:0};
                    c.celkoveBody = (c.celkoveBody || 0) + nb;
                    if(hitS) c.trefeneSkore = (c.trefeneSkore || 0) + 1;
                    return c;
                });
                if(!updates[`sazkyData_v2/zapasy/${mid}/sazky/${sid}/stav`]) {
                    updates[`sazkyData_v2/zapasy/${mid}/sazky/${sid}/stav`] = hitS ? "‚úÖ" : "‚ùå";
                }
            });

            updates[`sazkyData_v2/zapasy/${mid}/status`] = "vyhodnoceno";
            updates[`sazkyData_v2/zapasy/${mid}/vysledek`] = `${d}:${h}`;
            updates[`sazkyData_v2/zapasy/${mid}/strelciZapasu`] = currentStrelci;

            await db.ref().update(updates);
            await sendPush("Z√°pas vyhodnocen! üèÅ", `${z.domaci} - ${z.hoste} skonƒçilo ${d}:${h}. Koukni na body!`);
            alert("Vyhodnoceno a notifikace odesl√°na!");
            closeModal();
        });
    }

    function closeModal() { document.getElementById('modalOverlay').style.display='none'; document.getElementById('evalModal').style.display='none'; }
    function deleteMatch(id) { if(confirm("Smazat?")) db.ref('sazkyData_v2/zapasy/'+id).remove(); }
</script>
</body>
</html>
