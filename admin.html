<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin v2.0 - KANCEL√Å≈ò NADƒöJE</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <style>
        :root { 
            --blue: #00f2ff; --green: #38a169; --red: #e53e3e; --bg: #0f172a; --text: #ffffff;
            --card-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); padding: 20px; color: var(--text); margin: 0; }
        .container { max-width: 900px; margin: 0 auto; }
        .card { background: rgba(255,255,255,0.05); padding: 30px; border-radius: 20px; margin-bottom: 30px; border: 1px solid rgba(0,242,255,0.2); }
        h2 { border-bottom: 2px solid var(--blue); padding-bottom: 10px; font-size: 1.3em; }
        label { display: block; margin-top: 15px; font-weight: bold; font-size: 0.8em; opacity: 0.7; }
        input, textarea { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #334155; border-radius: 10px; background: #000; color: #fff; box-sizing: border-box; }
        .btn { padding: 15px; border: none; border-radius: 12px; color: #000; cursor: pointer; width: 100%; font-weight: bold; text-transform: uppercase; margin-top: 10px; transition: 0.3s; }
        .btn-blue { background: var(--blue); }
        .btn-green { background: var(--green); color: white; }
        .btn-red { background: var(--red); color: white; }
        .match-item { background: rgba(255,255,255,0.03); border: 1px solid #334155; padding: 20px; border-radius: 18px; margin-top: 20px; }
        .bet-admin-row { background: rgba(0,0,0,0.3); padding: 10px; border-radius: 10px; margin-top: 8px; font-size: 0.9em; display: flex; justify-content: space-between; align-items: center; }
        .modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 500px; background: #1e293b; border-radius: 25px; display: none; z-index: 3000; padding: 30px; border: 2px solid var(--blue); }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; z-index: 2999; }
        .tag-container { display: flex; flex-wrap: wrap; gap: 8px; margin: 15px 0; background: #000; padding: 10px; border-radius: 12px; }
        .tag { background: var(--blue); color: #000; padding: 4px 10px; border-radius: 10px; font-weight: bold; font-size: 0.8em; }
        #statusMsg { display: none; position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: var(--blue); color: #000; padding: 15px 30px; border-radius: 50px; font-weight: bold; z-index: 9999; }
    </style>
</head>
<body>

<div id="statusMsg">ZPR√ÅVA ODESL√ÅNA! üöÄ</div>

<div class="container">
    <div style="text-align: center; margin-bottom: 20px;">
        <img src="IMG_8429.png" style="max-width: 180px; filter: drop-shadow(0 0 10px var(--blue));">
    </div>
    
    <div class="card">
        <h2>üí∞ Bank & Statistiky (Verze 2.0)</h2>
        <label>P≈ôevod z minula (Kƒç):</label>
        <input type="number" id="prevBankInput">
        <button class="btn btn-blue" onclick="saveBank()">Ulo≈æit bank</button>
    </div>

    <div class="card">
        <h2>üöÄ Vypsat nov√Ω z√°pas</h2>
        <div style="display:flex; gap:10px;">
            <div style="flex:1;"><label>Dom√°c√≠:</label><input type="text" id="d" oninput="updateFlags()"></div>
            <div style="flex:1;"><label>Host√©:</label><input type="text" id="h" oninput="updateFlags()"></div>
        </div>
        <div style="display:flex; gap:10px;">
            <div style="flex:1;"><label>Vlajka D:</label><input type="text" id="kd" placeholder="nap≈ô. cz"></div>
            <div style="flex:1;"><label>Vlajka H:</label><input type="text" id="kh" placeholder="nap≈ô. ca"></div>
        </div>
        <label>Uz√°vƒõrka:</label>
        <input type="datetime-local" id="dl">
        <button class="btn btn-green" onclick="addM()">Uve≈ôejnit z√°pas</button>
    </div>

    <h2>üìä Aktivn√≠ z√°pasy</h2>
    <div id="activeMatches">Naƒç√≠t√°m...</div>

    <h2 style="margin-top:50px;">üìú Historie (Vyhodnoceno)</h2>
    <div id="historyMatches">Zat√≠m nic.</div>
</div>

<div id="modalOverlay" class="modal-overlay" onclick="closeModal()"></div>
<div id="evalModal" class="modal">
    <h3 style="text-align:center">üõ†Ô∏è Vyhodnotit v√Ωsledek</h3>
    <div style="display:flex; justify-content:center; gap:10px; margin: 20px 0;">
        <input type="number" id="finalD" style="width:60px; text-align:center; font-size:1.5em;">
        <span style="font-size:1.5em; line-height:2;">:</span>
        <input type="number" id="finalH" style="width:60px; text-align:center; font-size:1.5em;">
    </div>
    <label>St≈ôelci:</label>
    <div id="finalStrelci" class="tag-container"></div>
    <div style="display:flex; gap:5px;">
        <input type="text" id="addStrelecInput" placeholder="Jm√©no st≈ôelce..." style="margin:0;">
        <button class="btn btn-blue" style="width:auto; margin:0; padding:0 15px;" onclick="addTag()">+</button>
    </div>
    <button class="btn btn-green" id="confirmEvalBtn">VYPLATIT A ODESLAT NOTIFIKACI</button>
</div>

<script>
    // TV≈ÆJ FIREBASE CONFIG (Z≈ÆST√ÅV√Å)
    const firebaseConfig = { 
        apiKey: "AIzaSyC-NCdmsgA42FxnopKm92m1y5gUGw_z_uE", 
        authDomain: "nadeje-208bd.firebaseapp.com", 
        databaseURL: "https://nadeje-208bd-default-rtdb.europe-west1.firebasedatabase.app", 
        projectId: "nadeje-208bd", 
        storageBucket: "nadeje-208bd.firebasestorage.app", 
        messagingSenderId: "688478977789", 
        appId: "1:688478977789:web:512d1520cf96c9e59cc894" 
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    let currentStrelci = [];

    // WEBPUSHR KONFIGURACE (TV√â KL√çƒåE)
    async function sendPush(matchName, score) {
        const key = "E1831cba358cb7135d498741dc3d4d18";
        const token = "118988";
        try {
            await fetch('https://api.webpushr.com/v1/notification/send/all', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'webpushrKey': key, 'webpushrAuthToken': token },
                body: JSON.stringify({
                    "title": "Z√°pas vyhodnocen! ‚öΩ",
                    "message": `${matchName} skonƒçilo ${score}. Koukni na body!`,
                    "target_url": "https://sazkynadeje.github.io/SazkovkaNadeje/"
                })
            });
        } catch(e) { console.error(e); }
    }

    // NA≈†EPT√ÅVAƒå VLAJEK
    function updateFlags() {
        const flags = { 'ƒçes': 'cz', 'kan': 'ca', 'slo': 'sk', 'usa': 'us', 'fin': 'fi', '≈°v√©': 'se', 'nƒõm': 'de', '≈°v√Ω': 'ch', 'rus': 'ru' };
        const d = document.getElementById('d').value.toLowerCase();
        const h = document.getElementById('h').value.toLowerCase();
        for(let k in flags) {
            if(d.includes(k)) document.getElementById('kd').value = flags[k];
            if(h.includes(k)) document.getElementById('kh').value = flags[k];
        }
    }

    // Z√ÅKLADN√ç FUNKCE
    function saveBank() {
        db.ref('sazkyData_v2/prevedenyBank').set(parseInt(document.getElementById('prevBankInput').value) || 0);
        alert("Bank ulo≈æen!");
    }

    db.ref('sazkyData_v2/prevedenyBank').on('value', s => document.getElementById('prevBankInput').value = s.val() || 0);

    function addM() {
        const d = document.getElementById('d').value, h = document.getElementById('h').value,
              kd = document.getElementById('kd').value, kh = document.getElementById('kh').value, dl = document.getElementById('dl').value;
        if(!d || !h || !dl) return alert("Vypl≈à v≈°e!");
        db.ref('sazkyData_v2/zapasy').push({ domaci: d, hoste: h, kodD: kd, kodH: kh, deadline: dl, status: "aktivni" });
        alert("Z√°pas publikov√°n!");
    }

    // NAƒå√çT√ÅN√ç Z√ÅPAS≈Æ
    db.ref('sazkyData_v2/zapasy').on('value', snap => {
        const aC = document.getElementById('activeMatches'), hC = document.getElementById('historyMatches');
        aC.innerHTML = ""; hC.innerHTML = "";
        const data = snap.val(); if(!data) return;

        Object.entries(data).reverse().forEach(([mid, m]) => {
            const div = document.createElement('div');
            div.className = 'match-item';
            let betsHtml = "";
            if(m.sazky) {
                Object.values(m.sazky).forEach(s => {
                    betsHtml += `<div class="bet-admin-row"><span><b>${s.jmeno}</b>: ${s.tip || s.skore} (${s.strelec})</span> <span>${s.stav || ''}</span></div>`;
                });
            }

            div.innerHTML = `
                <div style="display:flex; justify-content:space-between;">
                    <strong>${m.domaci} vs ${m.hoste} ${m.vysledek ? '('+m.vysledek+')' : ''}</strong>
                    <button style="font-size:0.7em;" onclick="deleteM('${mid}')">Smazat</button>
                </div>
                ${!m.vysledek ? `<textarea id="raw-${mid}" placeholder="Vlo≈æ text z Livesportu..."></textarea>
                <button class="btn btn-blue" onclick="evalM('${mid}')">Vyhodnotit</button>` : ''}
                <div style="margin-top:10px; opacity:0.6; font-size:0.8em;">${betsHtml || '≈Ω√°dn√© s√°zky'}</div>
            `;
            if(m.status === "vyhodnoceno") hC.appendChild(div); else aC.appendChild(div);
        });
    });

    function evalM(mid) {
        const raw = document.getElementById(`raw-${mid}`).value; if(!raw) return alert("Vlo≈æ text!");
        let clean = raw.split(/PRODLOU≈ΩEN√ç|PENALTY|N√ÅJEZDY/i)[0];
        const sc = clean.match(/(\d+)\s*[:|-]\s*(\d+)/g);
        if(sc) {
            const l = sc[sc.length-1].replace(/\s/g,'').replace('-',':').split(':');
            document.getElementById('finalD').value = l[0]; document.getElementById('finalH').value = l[1];
        }
        currentStrelci = [];
        clean.split('\n').forEach(line => {
            if (line.match(/^[\d+]+['.]/)) {
                let n = line.replace(/^[\d+]+['.]\s*/, '').split('(')[0].split(',')[0].replace(/[0-9]/g, '').replace(/[:|-]/g, '').trim();
                if(n.length > 3) currentStrelci.push(n);
            }
        });
        renderTags();
        document.getElementById('modalOverlay').style.display='block';
        document.getElementById('evalModal').style.display='block';
        document.getElementById('confirmEvalBtn').onclick = () => finishEval(mid);
    }

    function renderTags() {
        const c = document.getElementById('finalStrelci'); c.innerHTML = "";
        currentStrelci.forEach((s, i) => c.innerHTML += `<div class="tag">${s} <span onclick="currentStrelci.splice(${i},1);renderTags()" style="cursor:pointer">√ó</span></div>`);
    }

    function addTag() {
        const v = document.getElementById('addStrelecInput').value;
        if(v) { currentStrelci.push(v); renderTags(); document.getElementById('addStrelecInput').value = ""; }
    }

    async function finishEval(mid) {
        const d = parseInt(document.getElementById('finalD').value);
        const h = parseInt(document.getElementById('finalH').value);
        const skoreStr = `${d}:${h}`;
        const fst = currentStrelci.map(s => s.toLowerCase().trim());

        db.ref(`sazkyData_v2/zapasy/${mid}`).once('value', async snap => {
            const z = snap.val();
            const sazkyEntries = Object.entries(z.sazky || {});
            
            // Logika banku
            const bankSnap = await db.ref('sazkyData_v2/prevedenyBank').get();
            let bank = (sazkyEntries.length * 20) + (parseInt(bankSnap.val()) || 0);

            let vyherciSkore = sazkyEntries.filter(([id, s]) => s.tip === skoreStr || s.skore === skoreStr);
            let vyherciBanku = vyherciSkore.filter(([id, s]) => fst.some(r => r.includes(s.strelec.toLowerCase().trim())));
            
            if(vyherciBanku.length === 0) vyherciBanku = vyherciSkore;

            const updates = {};
            if(vyherciBanku.length > 0) {
                const podil = Math.floor(bank / vyherciBanku.length);
                vyherciBanku.forEach(([sid, s]) => {
                    updates[`sazkyData_v2/zapasy/${mid}/sazky/${sid}/stav`] = "üèÜ";
                    updates[`sazkyData_v2/zapasy/${mid}/sazky/${sid}/vyhra`] = podil;
                    db.ref(`sazkyData_v2/stats/${s.jmeno}/vyhry`).transaction(c => (c||0) + podil);
                });
                updates[`sazkyData_v2/prevedenyBank`] = 0;
            } else {
                updates[`sazkyData_v2/prevedenyBank`] = bank;
            }

            // NB Body a Statistiky
            sazkyEntries.forEach(([sid, s]) => {
                const sTip = s.tip || s.skore;
                const tipD = parseInt(sTip.split(':')[0]), tipH = parseInt(sTip.split(':')[1]);
                const hitSkore = (tipD === d && tipH === h);
                const hitTrend = (tipD > tipH && d > h) || (tipD < tipH && d < h) || (tipD === tipH && d === h);
                const hitStrelec = fst.some(r => r.includes(s.strelec.toLowerCase().trim()));

                let nb = (hitSkore ? 5 : 0) + (hitStrelec ? 3 : 0) + (hitTrend ? 1 : 0);
                db.ref(`sazkyData_v2/stats/${s.jmeno}`).transaction(c => {
                    c = c || {celkoveBody:0, trefeneSkore:0};
                    c.celkoveBody = (c.celkoveBody || 0) + nb;
                    if(hitSkore) c.trefeneSkore = (c.trefeneSkore || 0) + 1;
                    return c;
                });
                if(!updates[`sazkyData_v2/zapasy/${mid}/sazky/${sid}/stav`]) {
                    updates[`sazkyData_v2/zapasy/${mid}/sazky/${sid}/stav`] = hitSkore ? "‚úÖ" : "‚ùå";
                }
            });

            updates[`sazkyData_v2/zapasy/${mid}/status`] = "vyhodnoceno";
            updates[`sazkyData_v2/zapasy/${mid}/vysledek`] = skoreStr;
            updates[`sazkyData_v2/zapasy/${mid}/strelciZapasu`] = currentStrelci;

            await db.ref().update(updates);
            await sendPush(`${z.domaci}-${z.hoste}`, skoreStr);
            
            showStatus("VYHODNOCENO A NOTIFIKACE ODESL√ÅNA! üöÄ");
            closeModal();
        });
    }

    function showStatus(txt) {
        const m = document.getElementById('statusMsg'); m.innerText = txt; m.style.display = 'block';
        setTimeout(() => m.style.display='none', 4000);
    }
    function closeModal() { document.getElementById('modalOverlay').style.display='none'; document.getElementById('evalModal').style.display='none'; }
    function deleteM(id) { if(confirm("Smazat?")) db.ref('sazkyData_v2/zapasy/'+id).remove(); }
</script>
</body>
</html>
