<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADMIN v2.0 - NADƒöJE</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        /* Tv√© barvy z adminu */
        :root { --blue: #3182ce; --green: #38a169; --red: #e53e3e; --bg: #f0f4f8; }
        body { font-family: sans-serif; background: var(--bg); padding: 20px; }
        .card { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .btn { padding: 15px; border: none; border-radius: 10px; color: white; cursor: pointer; width: 100%; font-weight: bold; margin-top: 5px; }
        .btn-blue { background: var(--blue); }
        .btn-green { background: var(--green); }
        .match-item { background: #fff; border: 1px solid #eee; padding: 15px; border-radius: 15px; margin-top: 10px; }
        textarea { width: 100%; height: 80px; border-radius: 8px; padding: 10px; border: 1px solid #ddd; }
    </style>
</head>
<body>

    <div style="max-width: 800px; margin: 0 auto;">
        <a href="index.html" style="text-decoration:none; color:gray;">‚Üê Zpƒõt na web</a>
        <h1>‚öôÔ∏è Administrace v2.0</h1>

        <div class="card">
            <h2>üöÄ Vypsat nov√Ω z√°pas</h2>
            <div style="display:flex; gap:10px;">
                <input type="text" id="d" placeholder="Dom√°c√≠">
                <input type="text" id="h" placeholder="Host√©">
            </div>
            <input type="text" id="kd" placeholder="K√≥d vlajky D (nap≈ô. cz)">
            <input type="text" id="kh" placeholder="K√≥d vlajky H (nap≈ô. ca)">
            <input type="datetime-local" id="dl">
            <button class="btn btn-green" id="addMatchBtn">Uve≈ôejnit z√°pas</button>
        </div>

        <div class="card">
            <h2>üìä Aktivn√≠ z√°pasy</h2>
            <div id="activeMatches">Naƒç√≠t√°m...</div>
        </div>
    </div>

    <script type="module">
        import { DBService } from './js/database.js';
        import { calculatePoints } from './js/core.js';

        const db = firebase.database();

        // 1. P≈òID√ÅN√ç Z√ÅPASU
        document.getElementById('addMatchBtn').onclick = () => {
            const d = document.getElementById('d').value, 
                  h = document.getElementById('h').value,
                  kd = document.getElementById('kd').value,
                  kh = document.getElementById('kh').value,
                  dl = document.getElementById('dl').value;

            if(!d || !h || !dl) return alert("Vypl≈à v≈°e!");

            db.ref('sazkyData/zapasy').push({
                domaci: d, hoste: h, kodD: kd, kodH: kh, deadline: dl, status: "aktivni"
            }).then(() => location.reload());
        };

        // 2. ZOBRAZEN√ç Z√ÅPAS≈Æ
        DBService.getMatches(data => {
            const container = document.getElementById('activeMatches');
            container.innerHTML = "";
            if(!data) return;

            Object.entries(data).forEach(([mid, m]) => {
                if(m.status === "vyhodnoceno") return;

                const div = document.createElement('div');
                div.className = 'match-item';
                div.innerHTML = `
                    <strong>${m.domaci} vs ${m.hoste}</strong>
                    <textarea id="raw-${mid}" placeholder="Vlo≈æ text z Livesportu pro vyhodnocen√≠..."></textarea>
                    <button class="btn btn-blue" id="eval-${mid}">VYHODNOTIT Z√ÅPAS</button>
                `;
                container.appendChild(div);

                document.getElementById(`eval-${mid}`).onclick = () => processEvaluation(mid, m);
            });
        });

        // 3. LOGIKA VYHODNOCEN√ç (Livesport Parser + Point Engine)
        async function processEvaluation(mid, match) {
            const raw = document.getElementById(`raw-${mid}`).value;
            if(!raw) return alert("Vlo≈æ text z Livesportu!");

            // --- PARSER ---
            let clean = raw.split(/PRODLOU≈ΩEN√ç|PENALTY/i)[0];
            const sc = clean.match(/(\d+)\s*[:|-]\s*(\d+)/g);
            if(!sc) return alert("Nepoda≈ôilo se naj√≠t sk√≥re!");
            
            const lastScore = sc[sc.length-1].replace(/\s/g,'').replace('-',':').split(':');
            const result = {
                skore: `${lastScore[0]}:${lastScore[1]}`,
                st≈ôelci: []
            };

            // Tah√°n√≠ st≈ôelc≈Ø (p≈ô√≠jmen√≠)
            clean.split('\n').forEach(line => {
                if (line.match(/^[\d+]+['.]/)) {
                    let n = line.replace(/^[\d+]+['.]\s*/, '').split('(')[0].split(',')[0].replace(/[0-9]/g, '').replace(/[:|-]/g, '').trim();
                    if(n.length > 2) result.st≈ôelci.push(n);
                }
            });

            if(!confirm(`Vyhodnotit jako ${result.skore}? St≈ôelci: ${result.st≈ôelci.join(', ')}`)) return;

            // --- V√ùPOƒåET A Z√ÅPIS ---
            const updates = {};
            const tips = match.sazky || {};
            
            for (const [tid, tip] of Object.entries(tips)) {
                const points = calculatePoints(tip, result);
                const pId = tip.userId || tip.jmeno; // Pou≈æijeme unik√°tn√≠ ID z verze 2.0

                // Aktualizace statistik (transakce by byla lep≈°√≠, ale pro jednoduchost v batchi)
                // Ve verzi 2.0 ukl√°d√°me do stats pod unik√°tn√≠m ID hr√°ƒçe
                const statRef = `sazkyData/stats/${pId}`;
                
                // Pozn√°mka: V ostr√©m provozu zde naƒçteme aktu√°ln√≠ stats a p≈ôiƒçteme body
                // Zde p≈ôipraveno pro z√°pis:
                updates[`${statRef}/lastMatch`] = mid;
                // Body se p≈ôiƒç√≠taj√≠ k celku
                db.ref(statRef).once('value', s => {
                    const current = s.val() || { celkoveBody: 0, pocetTipu: 0, trefeneSkore: 0 };
                    db.ref(statRef).update({
                        celkoveBody: current.celkoveBody + points.total,
                        pocetTipu: (current.pocetTipu || 0) + 1,
                        trefeneSkore: current.trefeneSkore + (points.score > 0 ? 1 : 0),
                        jmeno: tip.jmeno // Aby ve statistik√°ch bylo hezk√© jm√©no
                    });
                });
            }

            updates[`sazkyData/zapasy/${mid}/status`] = "vyhodnoceno";
            updates[`sazkyData/zapasy/${mid}/vysledek`] = result.skore;
            
            await db.ref().update(updates);
            alert("Z√°pas vyhodnocen a body rozdƒõleny!");
            location.reload();
        }
    </script>
</body>
</html>
