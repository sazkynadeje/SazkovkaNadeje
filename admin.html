<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADMIN v2.0 - KANCEL√Å≈ò NADƒöJE</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <style>
        :root { 
            --blue: #3182ce; --green: #38a169; --red: #e53e3e; --orange: #ed8936; 
            --bg: #f0f4f8; --text: #2d3748;
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); padding: 20px; color: var(--text); margin: 0; }
        .container { max-width: 900px; margin: 0 auto; }
        .card { background: white; padding: 30px; border-radius: 20px; margin-bottom: 30px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        h2 { margin-top: 0; border-bottom: 2px solid #edf2f7; padding-bottom: 12px; }
        label { display: block; margin-top: 15px; font-weight: bold; font-size: 0.85em; color: #718096; }
        input, textarea { width: 100%; padding: 14px; margin: 8px 0; border: 1px solid #cbd5e0; border-radius: 10px; box-sizing: border-box; }
        .btn { padding: 15px; border: none; border-radius: 12px; color: white; cursor: pointer; width: 100%; font-weight: bold; text-transform: uppercase; transition: 0.3s; margin-top: 10px; }
        .btn-blue { background: var(--blue); }
        .btn-green { background: var(--green); }
        .btn-orange { background: var(--orange); }
        .match-item { background: #f8fafc; border: 1px solid #e2e8f0; padding: 20px; border-radius: 18px; margin-top: 20px; }
        .status-badge { display: inline-block; padding: 4px 12px; border-radius: 10px; font-size: 0.8em; font-weight: bold; color: white; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="container">
    <div style="text-align: center; margin-bottom: 20px;">
        <img src="IMG_8429.png" style="max-width: 150px; border-radius: 20px;">
    </div>
    <a href="index.html" style="text-decoration: none; color: var(--blue); font-weight: bold;">‚Üê ZPƒöT NA WEB</a>
    <h1>‚öôÔ∏è Administrace v2.0</h1>

    <div class="card">
        <h2>üí∞ Spr√°va banku</h2>
        <label>Z≈Østatek z minul√Ωch kol (Kƒç):</label>
        <input type="number" id="prevBankInput">
        <button class="btn btn-blue" id="saveBankBtn">Ulo≈æit bank</button>
    </div>

    <div class="card">
        <h2>üöÄ Vypsat nov√Ω z√°pas</h2>
        <div style="display:flex; gap:15px;">
            <div style="flex:1;"><label>Dom√°c√≠:</label><input type="text" id="d" placeholder="Nap≈ô. ƒåesko"></div>
            <div style="flex:1;"><label>Host√©:</label><input type="text" id="h" placeholder="Nap≈ô. Kanada"></div>
        </div>
        <div style="display:flex; gap:15px;">
            <div style="flex:1;"><label>K√≥d vlajky D:</label><input type="text" id="kd" placeholder="cz"></div>
            <div style="flex:1;"><label>K√≥d vlajky H:</label><input type="text" id="kh" placeholder="ca"></div>
        </div>
        <label>Uz√°vƒõrka (Deadline):</label>
        <input type="datetime-local" id="dl">
        <button class="btn btn-green" id="addMatchBtn">Uve≈ôejnit na webu</button>
    </div>

    <div class="card">
        <h2>üìä Seznam z√°pas≈Ø</h2>
        <div id="matchList">Naƒç√≠t√°m...</div>
    </div>
</div>

<script type="module">
    import { DBService } from './js/database.js';
    import { calculatePoints } from './js/core.js';

    const db = firebase.database();

    // NAƒåTEN√ç BANKU
    DBService.getBank(val => document.getElementById('prevBankInput').value = val);
    document.getElementById('saveBankBtn').onclick = () => {
        const val = parseInt(document.getElementById('prevBankInput').value) || 0;
        db.ref('sazkyData/prevedenyBank').set(val).then(() => alert("Bank ulo≈æen."));
    };

    // P≈òID√ÅN√ç Z√ÅPASU
    document.getElementById('addMatchBtn').onclick = () => {
        const d = document.getElementById('d').value, h = document.getElementById('h').value,
              kd = document.getElementById('kd').value, kh = document.getElementById('kh').value,
              dl = document.getElementById('dl').value;
        if(!d || !h || !dl) return alert("Vypl≈à √∫daje!");
        db.ref('sazkyData/zapasy').push({ domaci: d, hoste: h, kodD: kd, kodH: kh, deadline: dl, status: "aktivni" })
          .then(() => { alert("Z√°pas vytvo≈ôen!"); location.reload(); });
    };

    // ZOBRAZEN√ç Z√ÅPAS≈Æ A VYHODNOCEN√ç
    DBService.getMatches(data => {
        const container = document.getElementById('matchList');
        container.innerHTML = "";
        if(!data) return;

        Object.entries(data).reverse().forEach(([mid, m]) => {
            const isDone = m.status === "vyhodnoceno";
            const div = document.createElement('div');
            div.className = 'match-item';
            div.innerHTML = `
                <div class="status-badge" style="background:${isDone ? 'var(--green)' : 'var(--blue)'}">
                    ${isDone ? 'VYHODNOCENO: ' + m.vysledek : 'AKTIVN√ç'}
                </div>
                <div style="font-size:1.2em; font-weight:bold; margin-bottom:10px;">${m.domaci} - ${m.hoste}</div>
                <textarea id="raw-${mid}" placeholder="Vlo≈æ text z Livesportu pro ${isDone ? 'opravu' : 'vyhodnocen√≠'}..."></textarea>
                <button class="btn ${isDone ? 'btn-orange' : 'btn-blue'}" id="eval-${mid}">
                    ${isDone ? 'üîÑ P≈òEVYHODNOTIT (OPRAVIT CHYBU)' : '‚úÖ VYHODNOTIT'}
                </button>
            `;
            container.appendChild(div);
            document.getElementById(`eval-${mid}`).onclick = () => processSmartEvaluation(mid, m);
        });
    });

    async function processSmartEvaluation(mid, match) {
        const raw = document.getElementById(`raw-${mid}`).value;
        if(!raw) return alert("Vlo≈æ text z Livesportu!");

        // PARSER
        let clean = raw.split(/PRODLOU≈ΩEN√ç|PENALTY/i)[0];
        const sc = clean.match(/(\d+)\s*[:|-]\s*(\d+)/g);
        if(!sc) return alert("Sk√≥re nenalezeno!");
        const lastScore = sc[sc.length-1].replace(/\s/g,'').replace('-',':').split(':');
        const result = { skore: `${lastScore[0]}:${lastScore[1]}`, st≈ôelci: [] };
        
        clean.split('\n').forEach(line => {
            if (line.match(/^[\d+]+['.]/)) {
                let n = line.replace(/^[\d+]+['.]\s*/, '').split('(')[0].split(',')[0].replace(/[0-9]/g, '').trim();
                if(n.length > 2) result.st≈ôelci.push(n);
            }
        });

        if(!confirm(`Vyhodnotit jako ${result.skore}? St≈ôelci: ${result.st≈ôelci.join(', ')}`)) return;

        const tips = match.sazky || {};
        const updates = {};

        // CHYTR√â P≈òEƒå√çT√ÅN√ç BOD≈Æ
        for (const [uid, tip] of Object.entries(tips)) {
            const pId = tip.userId || tip.jmeno;
            const statRef = db.ref(`sazkyData/stats/${pId}`);
            const newPoints = calculatePoints(tip, result);
            
            const oldPointsTotal = tip.lastPointsGranted || 0;
            const oldScoreHit = tip.lastScoreHit || 0;

            await statRef.transaction(current => {
                if (!current) {
                    current = { celkoveBody: 0, pocetTipu: 0, trefeneSkore: 0, jmeno: tip.jmeno };
                }
                // LOGIKA: Odeƒçti, co jsi dostal minule, a p≈ôiƒçti nov√© (Undo/Redo)
                current.celkoveBody = (current.celkoveBody || 0) - oldPointsTotal + newPoints.total;
                current.trefeneSkore = (current.trefeneSkore || 0) - oldScoreHit + (newPoints.score > 0 ? 1 : 0);
                
                // Poƒçet tip≈Ø se zv√Ω≈°√≠ jen p≈ôi prvn√≠m vyhodnocen√≠
                if (match.status !== "vyhodnoceno") {
                    current.pocetTipu = (current.pocetTipu || 0) + 1;
                }
                return current;
            });

            // Ulo≈æen√≠ z√°lohy do s√°zky
            updates[`sazkyData/zapasy/${mid}/sazky/${uid}/lastPointsGranted`] = newPoints.total;
            updates[`sazkyData/zapasy/${mid}/sazky/${uid}/lastScoreHit`] = (newPoints.score > 0 ? 1 : 0);
        }

        updates[`sazkyData/zapasy/${mid}/status`] = "vyhodnoceno";
        updates[`sazkyData/zapasy/${mid}/vysledek`] = result.skore;
        updates[`sazkyData/zapasy/${mid}/strelciZapasu`] = result.st≈ôelci;

        await db.ref().update(updates);
        alert("Body p≈ôepoƒç√≠t√°ny bez duplicit!");
        location.reload();
    }
</script>
</body>
</html>
