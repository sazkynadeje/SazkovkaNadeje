<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KANCEL√Å≈ò NADƒöJE v2.0</title>

    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="IMG_8429.png">

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        /* --- TV≈ÆJ KOMPLETN√ç NEONOV√ù DESIGN --- */
        :root {
            --neon: #00f2ff;
            --dark: #0f172a;
            --card-bg: rgba(255, 255, 255, 0.05);
            --transition-slow: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-fast: all 0.2s ease;
        }

        body {
            background-color: var(--dark);
            color: #ffffff;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0; padding: 15px;
            text-align: center;
            min-height: 100vh;
            display: flex; flex-direction: column; align-items: center;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        .header-logo {
            max-width: 450px; width: 90%;
            margin: 20px 0 40px 0;
            filter: drop-shadow(0 0 10px rgba(0, 242, 255, 0.5));
            animation: neonGlow 4s ease-in-out infinite alternate;
        }

        @keyframes neonGlow {
            0% { filter: drop-shadow(0 0 5px var(--neon)); transform: scale(1); }
            100% { filter: drop-shadow(0 0 25px var(--neon)); transform: scale(1.02); }
        }

        .bank-box {
            background: linear-gradient(180deg, rgba(255,255,255,0.03) 0%, rgba(0,242,255,0.08) 100%);
            border: 1px solid rgba(0, 242, 255, 0.4);
            border-radius: 30px; padding: 30px; min-width: 300px;
            margin-bottom: 40px; box-shadow: 0 20px 50px rgba(0,0,0,0.4);
        }

        .bank-main-val { font-size: 3.2em; font-weight: 900; text-shadow: 0 0 20px var(--neon); line-height: 1; }

        .btn-stats {
            display: inline-block; margin-bottom: 40px; padding: 16px 35px;
            background: rgba(0, 242, 255, 0.05); border: 1px solid var(--neon);
            color: var(--neon); text-decoration: none; border-radius: 100px;
            font-weight: 900; transition: var(--transition-slow); text-transform: uppercase;
        }

        #matchList { width: 100%; max-width: 650px; padding-bottom: 120px; }

        .match-card {
            background: var(--card-bg); border-radius: 35px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            margin-bottom: 35px; padding: 30px; transition: var(--transition-slow);
            backdrop-filter: blur(15px);
        }

        .flags-wrapper { display: flex; justify-content: center; align-items: center; gap: 25px; margin: 25px 0; }
        .flag-img {
            width: 110px; border-radius: 10px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.6);
            animation: flagWave 3s ease-in-out infinite;
        }

        @keyframes flagWave {
            0%, 100% { transform: rotateY(0deg); }
            50% { transform: rotateY(35deg) scale(1.05); }
        }

        .vs-circle {
            background: var(--neon); color: var(--dark);
            border-radius: 50%; width: 50px; height: 50px;
            line-height: 50px; font-weight: 900; box-shadow: 0 0 20px var(--neon);
        }

        .details { display: none; padding-top: 30px; border-top: 1px solid rgba(255,255,255,0.1); margin-top: 30px; text-align: left; }
        
        .score-row { display: flex; justify-content: center; align-items: center; gap: 20px; margin: 20px 0; }
        .score-input {
            width: 85px; height: 75px; text-align: center;
            font-weight: 900; font-size: 2.2em;
            background: #000; border: 3px solid #334155; color: white; border-radius: 22px;
        }

        .input-field {
            width: 100%; padding: 18px; background: rgba(0,0,0,0.4);
            border: 1px solid rgba(255,255,255,0.15); color: white;
            border-radius: 20px; box-sizing: border-box; margin-bottom: 20px;
        }

        .btn-add-ticket {
            width: 100%; background: var(--neon); color: var(--dark);
            border: none; padding: 22px; border-radius: 20px;
            font-weight: 900; cursor: pointer; text-transform: uppercase;
        }

        /* --- TLAƒå√çTKO PRO NOTIFIKACE --- */
        #enableNotifications {
            display: none;
            margin: 0 0 40px 0; padding: 15px 25px;
            background: transparent; border: 2px solid var(--neon);
            color: var(--neon); border-radius: 100px;
            font-weight: 900; cursor: pointer;
            box-shadow: 0 0 15px var(--neon);
            text-transform: uppercase; letter-spacing: 1px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 15px var(--neon); }
            50% { transform: scale(1.05); box-shadow: 0 0 25px var(--neon); }
            100% { transform: scale(1); box-shadow: 0 0 15px var(--neon); }
        }

        .fab-cart {
            position: fixed; bottom: 35px; right: 35px;
            width: 75px; height: 75px; background: var(--neon);
            color: var(--dark); border-radius: 50%;
            display: none; align-items: center; justify-content: center;
            font-size: 2em; z-index: 5000; box-shadow: 0 15px 40px rgba(0,242,255,0.4);
        }

        .badge {
            position: absolute; top: -5px; right: -5px;
            background: #ff4444; color: white; width: 28px; height: 28px;
            border-radius: 50%; font-size: 0.45em; display: flex;
            align-items: center; justify-content: center; border: 3px solid var(--dark);
        }

        .timer-box { font-size: 0.9em; font-weight: 800; color: var(--neon); background: rgba(0,0,0,0.6); padding: 10px 20px; border-radius: 100px; }

        /* --- MOD√ÅL --- */
        #notifModal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 10000; align-items: center; justify-content: center;
        }
        .modal-content {
            background: #1e293b; padding: 30px; border-radius: 30px; border: 2px solid var(--neon);
            max-width: 300px; text-align: center; box-shadow: 0 0 30px var(--neon);
        }
        .modal-btn {
            width: 100%; padding: 15px; margin-top: 15px; border-radius: 15px; border: none;
            font-weight: 900; text-transform: uppercase; cursor: pointer;
        }
        .btn-ano { background: var(--neon); color: var(--dark); }
        .btn-ne { background: rgba(255,255,255,0.1); color: white; }
    </style>
</head>
<body>

    <a href="admin.html" style="position:fixed; top:20px; right:20px; width:48px; height:48px; border:2px solid var(--neon); border-radius:50%; display:flex; align-items:center; justify-content:center; text-decoration:none; z-index:9999; background:rgba(15,23,42,0.9);">‚öôÔ∏è</a>

    <img src="IMG_8429.png" class="header-logo" alt="LOGO">

    <div class="bank-box">
        <span style="opacity:0.5; font-size:0.75em; letter-spacing:3px; text-transform:uppercase;">Celkov√Ω bank v h≈ôe</span>
        <div class="bank-main-val"><span id="uiMainBank">0</span> Kƒç</div>
        <div id="userWelcome" style="margin-top:15px; color:var(--neon); font-weight:bold; font-size:0.9em;"></div>
    </div>

    <button id="enableNotifications">üîî CHCI NOTIFIKACE O G√ìLECH</button>

    <a href="statistiky.html" class="btn-stats">üìä ≈ΩEB≈ò√çƒåKY A STATISTIKY</a>

    <div id="matchList">Naƒç√≠t√°m z√°pasy...</div>

    <div id="fabCart" class="fab-cart">
        üéüÔ∏è <div id="fabBadge" class="badge">0</div>
    </div>

    <div id="notifModal">
        <div class="modal-content">
            <h2 style="color:var(--neon)">NOTIFIKACE</h2>
            <p>Chce≈° dost√°vat upozornƒõn√≠ na g√≥ly a v√Ωsledky p≈ô√≠mo na displej?</p>
            <button id="btnNotifYes" class="modal-btn btn-ano">ANO, CHCI</button>
            <button id="btnNotifNo" class="modal-btn btn-ne">NECHCI</button>
        </div>
    </div>

    <script type="module">
        import { AuthService } from './js/auth.js';
        import { DBService } from './js/database.js';

        let cart = {};

        let user = AuthService.getUser();
        if (!user) {
            const name = prompt("V√≠tej! Zadej sv√© jm√©no pro s√°zky:");
            if (name) {
                user = AuthService.setUser(name);
                location.reload();
            }
        }

        if (user) {
            document.getElementById('userWelcome').innerText = `Hr√°ƒç: ${user.name}`;
        }

        DBService.getBank(val => document.getElementById('uiMainBank').innerText = val);
        
        DBService.getMatches(zapasy => {
            const container = document.getElementById('matchList');
            container.innerHTML = "";
            if (!zapasy) {
                container.innerHTML = "<div style='opacity:0.5'>Zat√≠m ≈æ√°dn√© aktivn√≠ z√°pasy</div>";
                return;
            }

            Object.entries(zapasy).forEach(([id, m]) => {
                if(m.status === "vyhodnoceno") return;

                const card = document.createElement('div');
                card.className = "match-card";
                card.onclick = () => {
                    const det = document.getElementById(`detail-${id}`);
                    det.style.display = det.style.display === 'block' ? 'none' : 'block';
                };

                card.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:18px;">
                        <div style="color:var(--neon); font-size:0.75em; font-weight:900; letter-spacing:1px;">ID: ${id.substring(0,4)}</div>
                        <div class="timer-box">‚è±Ô∏è ${m.deadline ? m.deadline.split('T')[1] : ''}</div>
                    </div>
                    <div class="flags-wrapper">
                        <div><img class="flag-img" src="https://flagcdn.com/w160/${m.kodD}.png"><br><small>${m.domaci}</small></div>
                        <div class="vs-circle">VS</div>
                        <div><img class="flag-img" src="https://flagcdn.com/w160/${m.kodH}.png"><br><small>${m.hoste}</small></div>
                    </div>
                    <div id="detail-${id}" class="details" onclick="event.stopPropagation()">
                        <div class="score-row">
                            <input type="number" id="scD-${id}" class="score-input" placeholder="0">
                            <span style="font-size:2.5em; font-weight:900; color:var(--neon)">:</span>
                            <input type="number" id="scH-${id}" class="score-input" placeholder="0">
                        </div>
                        <input type="text" id="striker-${id}" class="input-field" placeholder="St≈ôelec (p≈ô√≠jmen√≠)">
                        <button class="btn-add-ticket" id="add-btn-${id}">P≈òIDAT NA TIKET (20 Kƒç)</button>
                    </div>
                `;
                container.appendChild(card);

                document.getElementById(`add-btn-${id}`).onclick = () => {
                    const sD = document.getElementById(`scD-${id}`).value;
                    const sH = document.getElementById(`scH-${id}`).value;
                    const str = document.getElementById(`striker-${id}`).value;
                    if(sD === "" || sH === "" || !str) return alert("Vypl≈à v≈°e!");
                    cart[id] = { tip: `${sD}:${sH}`, strelec: str, skryt: false };
                    updateFAB();
                    document.getElementById(`detail-${id}`).style.display = 'none';
                };
            });
        });

        function updateFAB() {
            const count = Object.keys(cart).length;
            const fab = document.getElementById('fabCart');
            if(count > 0) {
                fab.style.display = 'flex';
                document.getElementById('fabBadge').innerText = count;
            }
        }

        document.getElementById('fabCart').onclick = async () => {
            if (confirm("Odeslat tiket?")) {
                try {
                    await DBService.sendTicket(cart);
                    alert("Tiket odesl√°n!");
                    cart = {};
                    location.reload();
                } catch (e) { alert(e.message); }
            }
        };
    </script>

    <script>
    (function(w,d, s, id) {
        if(typeof(w.webpushr)!=='undefined') return;
        w.webpushr=w.webpushr||function(){(w.webpushr.q=w.webpushr.q||[]).push(arguments)};
        var js, fjs = d.getElementsByTagName(s)[0];
        js = d.createElement(s); js.id = id;js.async=1;
        js.src = "https://cdn.webpushr.com/app.min.js";
        fjs.parentNode.appendChild(js);
    }(window,document, 'script', 'webpushr-jssdk-alternative'));

    // --- KL√çƒåOV√Å ZMƒöNA: NOV√ù PUBLIC KEY A RELATIVN√ç CESTY ---
    webpushr('init','BJLqlsfhPhmUGRT1vU8Ob_iUP0ZGtgh2-jGjhFTc8u_rCYpSIBMjasZ1HPA0EJSUDjRfpB59-lv7i1B3zObvF5w','webpushr-sw.js','/SazkovkaNadeje/');

    webpushr('setup', { 
        'in_app_notification': false, 
        'onsite_messaging': false 
    });

    // --- FUNKCE PRO AKTIVACI (S iPHONE FIXEM) ---
    const activatePush = async (e) => {
        if(e) e.preventDefault(); 
        console.log("Bud√≠m Service Worker a ≈æ√°d√°m o odbƒõr...");
        
        try {
            // Fix pro iPhone: Ruƒçn√≠ registrace p≈ôed zavol√°n√≠m fetch_subscription
            if ('serviceWorker' in navigator) {
                await navigator.serviceWorker.register('webpushr-sw.js', { scope: '/SazkovkaNadeje/' });
            }

            if(typeof webpushr !== 'undefined') {
                webpushr('fetch_subscription', function(result) {
                    console.log("Webpushr v√Ωsledek:", result);
                    if(result.status === 'success') {
                        localStorage.setItem('notifChoice', 'ano');
                        document.getElementById('notifModal').style.display = 'none';
                        document.getElementById('enableNotifications').style.display = 'none';
                        alert("Odbƒõr aktivov√°n! ‚öΩ");
                    } else {
                        alert("Chyba: " + result.description + "\n\nUjisti se, ≈æe m√°≈° web p≈ôidan√Ω NA PLO≈†E!");
                        document.getElementById('notifModal').style.display = 'none';
                    }
                });
            }
        } catch (err) {
            console.error("Kritick√° chyba registrace:", err);
        }
    };

    window.addEventListener('load', function() {
        setTimeout(function() {
            const choice = localStorage.getItem('notifChoice');
            const modal = document.getElementById('notifModal');
            const neonBtn = document.getElementById('enableNotifications');

            if(!choice) {
                modal.style.display = 'flex';
            }

            if(typeof webpushr !== 'undefined') {
                webpushr('notification_status', function(status) {
                    if(status !== 'granted' && choice !== 'ne') {
                        neonBtn.style.display = 'inline-block';
                    }
                });
            }
            
            // Listenery pro iOS (click i touchend pro jistotu)
            const btnYes = document.getElementById('btnNotifYes');
            btnYes.addEventListener('click', activatePush);
            btnYes.addEventListener('touchend', activatePush);
            
            neonBtn.addEventListener('click', activatePush);
            neonBtn.addEventListener('touchend', activatePush);

            document.getElementById('btnNotifNo').addEventListener('click', () => {
                localStorage.setItem('notifChoice', 'ne');
                modal.style.display = 'none';
            });
        }, 4000);
    });
    </script>
</body>
</html>
