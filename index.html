<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DEBUG TEST v2.0</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="IMG_8429.png">

    <style>
        body { font-family: -apple-system, sans-serif; background: #000; color: #fff; text-align: center; padding: 20px; }
        .card { background: #111; border: 2px solid #00f2ff; border-radius: 20px; padding: 20px; margin-bottom: 20px; box-shadow: 0 0 15px rgba(0,242,255,0.3); }
        button { width: 100%; padding: 20px; border-radius: 15px; border: none; font-weight: 900; font-size: 1.1em; cursor: pointer; margin: 10px 0; }
        #testBtn { background: #00f2ff; color: #000; }
        #btnSend { background: #ff00ff; color: #fff; display: none; }
        .debug-box { text-align: left; background: #222; padding: 15px; border-radius: 10px; font-family: monospace; font-size: 12px; color: #00ff00; overflow-x: scroll; }
        .status-line { margin: 10px 0; font-weight: bold; }
    </style>
</head>
<body>

    <div class="card">
        <h2>üö® DIAGNOSTIKA</h2>
        <div id="statusLine" class="status-line">Inicializace...</div>
        <button id="testBtn">1. AKTIVOVAT ODBƒöR</button>
    </div>

    <div class="card" id="sendCard" style="display:none;">
        <h2>üöÄ ODESL√ÅN√ç</h2>
        <button id="btnSend">2. POSLAT TEST PUSH</button>
    </div>

    <div class="debug-box" id="debug">
        [LOG]: Startuji diagnostiku...<br>
    </div>

    <script>
        const debug = document.getElementById('debug');
        const statusLine = document.getElementById('statusLine');

        function log(msg) {
            debug.innerHTML += "[LOG]: " + msg + "<br>";
            console.log(msg);
        }

        // --- SDK WEBPUSHR ---
        (function(w,d, s, id) {
            if(typeof(w.webpushr)!=='undefined') return;
            w.webpushr=w.webpushr||function(){(w.webpushr.q=w.webpushr.q||[]).push(arguments)};
            var js, fjs = d.getElementsByTagName(s)[0];
            js = d.createElement(s); js.id = id;js.async=1;
            js.src = "https://cdn.webpushr.com/app.min.js";
            fjs.parentNode.appendChild(js);
        }(window,document, 'script', 'webpushr-jssdk-alternative'));

        // TV≈ÆJ NOV√ù PUBLIC KEY
        webpushr('init','BJLqlsfhPhmUGRT1vU8Ob_iUP0ZGtgh2-jGjhFTc8u_rCYpSIBMjasZ1HPA0EJSUDjRfpB59-lv7i1B3zObvF5w','webpushr-sw.js','/SazkovkaNadeje/');
        webpushr('setup', { 'in_app_notification': false, 'onsite_messaging': false });

        // --- KONTROLA STAVU ---
        function updateStatus() {
            if (typeof webpushr !== 'undefined') {
                webpushr('notification_status', function(status) {
                    statusLine.innerText = "Stav syst√©mu: " + status.toUpperCase();
                    log("Webpushr status: " + status);
                    if (status === 'granted') {
                        document.getElementById('sendCard').style.display = 'block';
                        document.getElementById('btnSend').style.display = 'block';
                    }
                });
            } else {
                log("ƒåek√°m na naƒçten√≠ SDK...");
                setTimeout(updateStatus, 1000);
            }
        }

        updateStatus();

        // --- TLAƒå√çTKO 1: REGISTRACE ---
        document.getElementById('testBtn').onclick = function() {
            log("Kliknuto na registraci...");
            statusLine.innerText = "≈Ω√ÅD√ÅM O POVOLEN√ç...";

            webpushr('fetch_subscription', function(result) {
                log("V√Ωsledek fetch: " + JSON.stringify(result));
                if(result.status === 'success') {
                    statusLine.innerHTML = "<span style='color:lime'>√öSPƒöCH! ‚úÖ</span>";
                    document.getElementById('sendCard').style.display = 'block';
                    document.getElementById('btnSend').style.display = 'block';
                } else {
                    statusLine.innerHTML = "<span style='color:red'>CHYBA! ‚ùå</span>";
                    alert("Selhalo to: " + result.description);
                }
            });
        };

        // --- TLAƒå√çTKO 2: ODESL√ÅN√ç ---
        document.getElementById('btnSend').onclick = async function() {
            log("Pokus o odesl√°n√≠ p≈ôes REST API...");
            const body = {
                "title": "TEST v2.0 FUNGUJE!",
                "message": "Pokud to vid√≠≈°, nov√© kl√≠ƒçe jsou v po≈ô√°dku.",
                "target_url": "https://sazkynadeje.github.io/SazkovkaNadeje/",
                "urgency": "high"
            };

            try {
                const response = await fetch('https://api.webpushr.com/v1/notification/send/all', {
                    method: 'POST',
                    headers: {
                        'webpushrKey': 'cc80b06b1a513c4ac1227033bda09e2a',
                        'webpushrAuthToken': '119013',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(body)
                });
                const data = await response.json();
                log("Odpovƒõƒè API: " + JSON.stringify(data));
                if(data.status === 'success') alert("Notifikace odesl√°na! Sleduj displej.");
            } catch (e) {
                log("KRITICK√Å CHYBA API: " + e);
            }
        };
    </script>
</body>
</html>
