<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KANCELÁŘ TEST v2.0</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="IMG_8429.png">

    <style>
        body { font-family: -apple-system, system-ui, sans-serif; background: #0f172a; color: #fff; text-align: center; padding: 20px; margin: 0; }
        .card { background: #1e293b; border: 2px solid #00f2ff; border-radius: 25px; padding: 25px; margin-bottom: 20px; box-shadow: 0 0 20px rgba(0,242,255,0.2); }
        h2 { color: #00f2ff; margin-top: 0; }
        button { width: 100%; padding: 22px; border-radius: 18px; border: none; font-weight: 900; font-size: 1.1em; cursor: pointer; margin: 10px 0; -webkit-tap-highlight-color: transparent; }
        #testBtn { background: #00f2ff; color: #0f172a; box-shadow: 0 5px 15px rgba(0,242,255,0.4); }
        #btnSend { background: #ff00ff; color: #fff; display: none; }
        .log-box { text-align: left; background: #000; padding: 15px; border-radius: 15px; font-family: monospace; font-size: 11px; color: #00ff00; height: 150px; overflow-y: auto; border: 1px solid #334155; }
        .status-badge { display: inline-block; padding: 5px 15px; border-radius: 100px; background: #334155; font-weight: bold; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div class="card">
        <h2>1. REGISTRACE</h2>
        <div id="statusBadge" class="status-badge">Načítám...</div>
        <button id="testBtn">AKTIVOVAT OZNÁMENÍ</button>
    </div>

    <div id="sendCard" class="card" style="display:none;">
        <h2>2. TEST ODESLÁNÍ</h2>
        <p style="font-size: 0.9em; opacity: 0.8;">Teď zkusíme odeslat zprávu přes tvé nové API klíče.</p>
        <button id="btnSend">POSLAT TEST PUSH</button>
    </div>

    <div class="log-box" id="debugLog">
        [SYSTEM]: Diagnostika spuštěna...<br>
    </div>

    <script>
        const log = (msg) => {
            const d = document.getElementById('debugLog');
            d.innerHTML += `> ${msg}<br>`;
            d.scrollTop = d.scrollHeight;
            console.log(msg);
        };

        const statusBadge = document.getElementById('statusBadge');

        // --- WEBPUSHR SDK ---
        (function(w,d, s, id) {
            if(typeof(w.webpushr)!=='undefined') return;
            w.webpushr=w.webpushr||function(){(w.webpushr.q=w.webpushr.q||[]).push(arguments)};
            var js, fjs = d.getElementsByTagName(s)[0];
            js = d.createElement(s); js.id = id;js.async=1;
            js.src = "https://cdn.webpushr.com/app.min.js";
            fjs.parentNode.appendChild(js);
        }(window,document, 'script', 'webpushr-jssdk-alternative'));

        // TVŮJ NOVÝ PUBLIC KEY
        webpushr('init','BJLqlsfhPhmUGRT1vU8Ob_iUP0ZGtgh2-jGjhFTc8u_rCYpSIBMjasZ1HPA0EJSUDjRfpB59-lv7i1B3zObvF5w','webpushr-sw.js','/SazkovkaNadeje/');
        webpushr('setup', { 'in_app_notification': false, 'onsite_messaging': false });

        // --- KONTROLA STAVU ---
        function checkWebpushr() {
            if (typeof webpushr !== 'undefined') {
                webpushr('notification_status', function(status) {
                    statusBadge.innerText = status.toUpperCase();
                    log("Stav Webpushru: " + status);
                    if (status === 'granted') {
                        document.getElementById('sendCard').style.display = 'block';
                        document.getElementById('btnSend').style.display = 'block';
                    }
                });
            } else {
                log("Hledám SDK...");
                setTimeout(checkWebpushr, 1000);
            }
        }
        checkWebpushr();

        // --- FUNKCE PRO REGISTRACI ---
        const handleRegister = (e) => {
            if(e) e.preventDefault();
            log("Požadavek na registraci odeslán...");
            statusBadge.innerText = "PROSÍM ČEKEJ...";

            webpushr('fetch_subscription', function(result) {
                log("Výsledek: " + JSON.stringify(result));
                if(result.status === 'success') {
                    statusBadge.innerHTML = "POVOLENO ✅";
                    statusBadge.style.color = "#00ff00";
                    document.getElementById('sendCard').style.display = 'block';
                    document.getElementById('btnSend').style.display = 'block';
                    alert("Úspěch! iPhone notifikace přijal.");
                } else {
                    statusBadge.innerHTML = "CHYBA ❌";
                    alert("Chyba: " + result.description);
                }
            });
        };

        // Podpora pro klik i dotyk (iOS fix)
        const regBtn = document.getElementById('testBtn');
        regBtn.addEventListener('click', handleRegister);
        regBtn.addEventListener('touchend', handleRegister);

        // --- FUNKCE PRO ODESLÁNÍ ---
        document.getElementById('btnSend').onclick = async function() {
            log("Odesílám přes tvé REST API...");
            const body = {
                "title": "TEST v2.0 - FUNGUJE TO!",
                "message": "Nové klíče jsou v pořádku. Píp!",
                "target_url": "https://sazkynadeje.github.io/SazkovkaNadeje/",
                "urgency": "high"
            };

            try {
                const response = await fetch('https://api.webpushr.com/v1/notification/send/all', {
                    method: 'POST',
                    headers: {
                        'webpushrKey': 'cc80b06b1a513c4ac1227033bda09e2a',
                        'webpushrAuthToken': '119013',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(body)
                });
                const data = await response.json();
                log("Odpověď API: " + JSON.stringify(data));
                if(data.status === 'success') alert("Zpráva odeslána všem!");
            } catch (e) {
                log("CHYBA API: " + e);
            }
        };
    </script>
</body>
</html>
